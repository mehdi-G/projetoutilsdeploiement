#!/bin/bash

# Créer un réseau Docker si ce n'est pas déjà fait
docker network create my_network || true

# Lancer les conteneurs web1, web2, et web3 dans le même réseau
docker run -d --name web1 --network my_network alpine /bin/sh -c "while true; do sleep 30; done"
docker run -d --name web2 --network my_network alpine /bin/sh -c "while true; do sleep 30; done"
docker run -d --name web3 --network my_network alpine /bin/sh -c "while true; do sleep 30; done"

echo "Les conteneurs suivants ont été créés :"
docker ps --format "table {{.Names}}\t{{.Status}}"

# Demander à l'utilisateur sur quel conteneur installer Ansible
echo "Choisissez un conteneur pour installer Ansible :"
read -p "Entrez le nom du conteneur (web1, web2, web3) : " chosen_container

# Vérifier si le conteneur existe
if [ "$(docker ps -q -f name=$chosen_container)" ]; then
    # Installer Ansible dans le conteneur choisi
    echo "Installation d'Ansible..."
    docker exec $chosen_container sh -c "apk add --no-cache ansible openssh sshpass"

    # Vérifier si Ansible est installé
    ansible_installed=$(docker exec $chosen_container ansible --version 2>&1)
    
    if [ "$(echo $ansible_installed | grep 'ansible')" ]; then
        echo "Ansible a été installé avec succès dans le conteneur $chosen_container !"
    else
        echo "Erreur lors de l'installation d'Ansible dans le conteneur $chosen_container."
        echo "Détails : $ansible_installed"
        exit 1
    fi

    # Copier le playbook.yml dans le conteneur choisi
    echo "Copie de playbook.yml dans le conteneur $chosen_container..."
    docker cp playbook.yml $chosen_container:/playbook.yml

    # Installer la clé SSH dans le conteneur choisi
    docker exec $chosen_container sh -c "ssh-keygen -t rsa -N '' -f /root/.ssh/id_rsa"

    # Créer le fichier inventory.ini
    echo "Création du fichier inventory.ini dans le conteneur..."
    docker exec $chosen_container sh -c "echo '[webservers]' > /root/inventory.ini"
    
    # Obtenir les adresses IP des conteneurs et les ajouter à inventory.ini
    for container in web1 web2 web3; do
        if [ "$container" != "$chosen_container" ]; then
            ip_address=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $container)
            echo "Ajout de $container avec IP: $ip_address dans inventory.ini..."
            docker exec $chosen_container sh -c "echo '$container ansible_host=$ip_address' >> /root/inventory.ini"
        fi
    done

    echo "Fichier inventory.ini créé dans le conteneur $chosen_container."

    # Installer et démarrer SSH sur tous les conteneurs
    for container in web1 web2 web3; do
        echo "Installation de SSH sur $container..."
        docker exec $container sh -c "apk add --no-cache openssh"
        docker exec $container sh -c "/usr/sbin/sshd"
    done

    # Copier la clé SSH publique dans les autres conteneurs
    for container in web2 web3; do
        echo "Copie de la clé SSH publique dans $container..."
        docker exec $chosen_container sh -c "cat /root/.ssh/id_rsa.pub" | docker exec -i $container sh -c "mkdir -p /root/.ssh && cat >> /root/.ssh/authorized_keys"
    done

    # Ajouter les adresses IP des conteneurs dans /etc/hosts
    for container in web1 web2 web3; do
        ip_address=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $container)
        echo "Ajout de $container avec IP: $ip_address dans /etc/hosts..."
        docker exec $chosen_container sh -c "echo '$ip_address $container' >> /etc/hosts"
    done

    echo "Clé SSH copiée sur les autres conteneurs."

    # --- AJOUTER LA PARTIE AVEC CIBLE-CONTAINER ---

    # Demander l'adresse IP du conteneur cible-container
    echo "Veuillez entrer l'adresse IP du conteneur cible-container :"
    read -p "Entrez l'IP de cible-container : " cible_ip

    # Demander le nombre de requêtes à envoyer
    echo "Combien de requêtes chaque conteneur doit-il envoyer à cible-container ?"
    read -p "Entrez le nombre de requêtes à envoyer : " nb_requetes

    # Envoyer un message à cible-container depuis tous les conteneurs sauf celui choisi pour Ansible
    for container in web1 web2 web3; do
        if [ "$container" != "$chosen_container" ]; then
            echo "Le conteneur $container va envoyer $nb_requetes requêtes à cible-container ($cible_ip)..."
            docker exec $container sh -c "apk add --no-cache curl"
            for i in $(seq 1 $nb_requetes); do
                docker exec $container sh -c "curl -X POST -d 'Hello from $container - Requête $i' http://$cible_ip:8080"
            done
        fi
    done

    # --- FIN DES AJOUTS ---

    # Vérifier si le playbook existe avant de l'exécuter
    if docker exec $chosen_container [ -f /playbook.yml ]; then
        # Lancer le playbook Ansible
        docker exec $chosen_container sh -c "ansible-playbook -i /root/inventory.ini /playbook.yml"
    else
        echo "ERROR! Le playbook: /playbook.yml est introuvable."
    fi

else
    echo "Le conteneur choisi n'existe pas. Veuillez vérifier le nom et réessayer."
fi
